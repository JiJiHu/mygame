<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü•ä Êã≥ÁöáÊ†ºÊñó</title>
    <link rel="stylesheet" href="../onepiece-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .close-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e94560;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            color: #e94560;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #e94560;
            color: white;
            transform: rotate(90deg);
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ‰∏ªËèúÂçï */
        .menu-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 20px;
        }

        .menu-title {
            font-size: 72px;
            font-weight: bold;
            color: #ff6b35;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.8),
                         0 0 40px rgba(255, 107, 53, 0.6),
                         4px 4px 0 #1a1a2e,
                         8px 8px 0 #16213e;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .menu-subtitle {
            font-size: 28px;
            color: #ffffff;
            margin-bottom: 60px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .menu-btn {
            display: block;
            width: 280px;
            padding: 20px 40px;
            margin: 15px;
            font-size: 22px;
            font-weight: bold;
            color: white;
            background: linear-gradient(145deg, #e94560, #d63447);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 0 #a02030,
                        0 10px 30px rgba(233, 69, 96, 0.4);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .menu-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #a02030,
                        0 15px 40px rgba(233, 69, 96, 0.5);
        }

        .menu-btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 0 #a02030,
                        0 5px 15px rgba(233, 69, 96, 0.4);
        }

        .menu-btn.secondary {
            background: linear-gradient(145deg, #0f3460, #16213e);
            box-shadow: 0 6px 0 #0a213a,
                        0 10px 30px rgba(15, 52, 96, 0.4);
        }

        .menu-btn.secondary:hover {
            box-shadow: 0 9px 0 #0a213a,
                        0 15px 40px rgba(15, 52, 96, 0.5);
        }

        /* Ê∏∏ÊàèÁïåÈù¢ */
        .game-screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
        }

        .hud {
            width: 90%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 20px;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .player-info {
            width: 45%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-name {
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .health-bar-container {
            width: 100%;
            height: 30px;
            background: #2d2d44;
            border: 3px solid #444;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .health-bar {
            height: 100%;
            transition: width 0.3s;
            border-radius: 3px;
        }

        .health-bar.p1 {
            background: linear-gradient(90deg, #ff4444, #ff6b6b);
            margin-left: auto;
        }

        .health-bar.p2 {
            background: linear-gradient(90deg, #4444ff, #6b6bff);
        }

        .energy-container {
            width: 100%;
            height: 15px;
            background: #2d2d44;
            border: 2px solid #444;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }

        .energy-bar {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4a);
            transition: width 0.2s;
        }

        .timer {
            font-size: 48px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8),
                         2px 2px 4px rgba(0, 0, 0, 0.8);
            min-width: 80px;
            text-align: center;
        }

        .timer-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            font-size: 20px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-btn:hover {
            background: rgba(233, 69, 96, 0.8);
            border-color: rgba(233, 69, 96, 1);
            transform: scale(1.1);
        }

        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: relative;
        }

        #gameCanvas {
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 70%, #8B4513 100%);
            border: 4px solid #2d2d44;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 72px;
            font-weight: bold;
            color: #ff6b35;
            text-shadow: 3px 3px 0 #1a1a2e,
                         6px 6px 0 #16213e;
            animation: comboPopup 0.5s;
            pointer-events: none;
        }

        @keyframes comboPopup {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .game-over h1 {
            font-size: 64px;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .game-over p {
            font-size: 28px;
            color: white;
            margin-bottom: 40px;
        }

        /* Â∏ÆÂä©Èù¢Êùø */
        .controls-help {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .help-row {
            display: flex;
            align-items: center;
            margin: 5px 0;
            gap: 20px;
        }

        .help-player {
            font-weight: bold;
            min-width: 60px;
        }

        .help-player.p1 { color: #ff6b6b; }
        .help-player.p2 { color: #6b6bff; }

        .help-keys {
            display: flex;
            gap: 5px;
        }

        .key {
            background: #444;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
            border: 1px solid #666;
        }

        /* ÈöêËóè/ÊòæÁ§∫ÊéßÂà∂ */
        .hidden { display: none !important; }
        .visible { display: flex !important; }

        /* ÁßªÂä®Á´ØËôöÊãüÊéßÂà∂ */
        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
        }

        @media (max-width: 768px) {
            .mobile-controls {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .controls-help {
                display: none;
            }

            .game-container {
                padding-bottom: 180px;
            }

            #gameCanvas {
                max-width: 100%;
                height: auto;
            }

            .menu-title {
                font-size: 36px;
            }

            .menu-subtitle {
                font-size: 18px;
            }

            .menu-btn {
                width: 240px;
                font-size: 18px;
                padding: 15px 30px;
            }

            .hud {
                padding: 10px;
                font-size: 12px;
            }

            .player-name {
                font-size: 16px;
            }

            .health-bar-container {
                height: 20px;
            }

            .timer {
                font-size: 32px;
            }
        }

        .joystick-container {
            width: 120px;
            height: 120px;
        }

        .joystick {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            position: relative;
        }

        .joystick-knob {
            width: 50px;
            height: 50px;
            background: rgba(255, 107, 53, 0.8);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.8);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            transition: all 0.1s;
        }

        .action-btn:active {
            background: rgba(255, 107, 53, 0.8);
            transform: scale(0.95);
            border-color: rgba(255, 107, 53, 1);
        }

        .btn-jump {
            background: rgba(0, 255, 135, 0.5);
        }

        .btn-jump:active {
            background: rgba(0, 255, 135, 0.8);
        }

        .btn-attack {
            background: rgba(255, 0, 135, 0.5);
        }

        .btn-attack:active {
            background: rgba(255, 0, 135, 0.8);
        }

        .btn-special {
            background: rgba(255, 215, 0, 0.5);
        }

        .btn-special:active {
            background: rgba(255, 215, 0, 0.8);
        }
    </style>
</head>
<body>
    <button class="close-btn" onclick="goToMenu()" title="ËøîÂõûËèúÂçï">√ó</button>

    <!-- ‰∏ªËèúÂçï -->
    <div id="menuScreen" class="menu-screen">
        <h1 class="menu-title">ü•ä Êã≥ÁöáÊ†ºÊñó</h1>
        <p class="menu-subtitle">ÁªèÂÖ∏Ê†ºÊñóÔºåÁÉ≠Ë°ÄÂØπÂÜ≥</p>
        <button class="menu-btn" onclick="startGame('pvp')">Âèå‰∫∫ÂØπÊàò</button>
        <button class="menu-btn" onclick="startGame('ai')">AI ÂØπÊàò</button>
        <button class="menu-btn secondary" onclick="showControls()">Êìç‰ΩúËØ¥Êòé</button>
    </div>

    <!-- Ê∏∏ÊàèÁïåÈù¢ -->
    <div id="gameScreen" class="game-screen hidden">
        <div class="hud">
            <div class="player-info">
                <div class="player-name">PLAYER 1</div>
                <div class="health-bar-container">
                    <div id="healthP1" class="health-bar p1" style="width: 100%"></div>
                </div>
                <div class="energy-container">
                    <div id="energyP1" class="energy-bar" style="width: 0%"></div>
                </div>
            </div>

            <div class="timer-section">
                <button class="back-btn" onclick="goToMenu()" title="ËøîÂõûËèúÂçï">‚Üê</button>
                <div class="timer" id="timer">99</div>
            </div>

            <div class="player-info">
                <div class="player-name">PLAYER 2</div>
                <div class="health-bar-container">
                    <div id="healthP2" class="health-bar p2" style="width: 100%"></div>
                </div>
                <div class="energy-container">
                    <div id="energyP2" class="energy-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="gameCanvas"></canvas>
        </div>

        <div class="controls-help">
            <div class="help-row">
                <span class="help-player p1">P1:</span>
                <div class="help-keys">
                    <span class="key">WASD</span> ÁßªÂä®
                    <span class="key">J</span> Êã≥
                    <span class="key">K</span> ËÑö
                    <span class="key">L</span> ÂøÖÊùÄ
                </div>
            </div>
            <div class="help-row">
                <span class="help-player p2">P2:</span>
                <div class="help-keys">
                    <span class="key">‚Üë‚Üì‚Üê‚Üí</span> ÁßªÂä®
                    <span class="key">1</span> Êã≥
                    <span class="key">2</span> ËÑö
                    <span class="key">3</span> ÂøÖÊùÄ
                </div>
            </div>
        </div>

        <!-- ÁßªÂä®Á´ØËôöÊãüÊéßÂà∂ -->
        <div class="mobile-controls" id="mobileControls">
            <div class="joystick-container">
                <div class="joystick" id="joystick">
                    <div class="joystick-knob" id="joystickKnob"></div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn btn-jump" data-action="jump">‚Üë</button>
                <button class="action-btn btn-attack" data-action="attack">üëä</button>
                <button class="action-btn btn-attack" data-action="attack2">ü¶∂</button>
                <button class="action-btn btn-special" data-action="special">‚ö°</button>
            </div>
        </div>
    </div>

    <!-- Ê∏∏ÊàèÁªìÊùü -->
    <div id="gameOver" class="game-over">
        <h1 id="winnerText">PLAYE R1 Ëé∑ËÉú!</h1>
        <p id="scoreText">ÊØîÂàÜ 2 - 1</p>
        <button class="menu-btn" onclick="restartGame()">ÂÜçÊù•‰∏ÄÂ±Ä</button>
        <button class="menu-btn secondary" onclick="goToMenu()">ËøîÂõûËèúÂçï</button>
    </div>

    <script>
        // ==================== Ê∏∏ÊàèÈÖçÁΩÆ ====================
        const CONFIG = {
            canvasWidth: 1000,
            canvasHeight: 600,
            gravity: 0.8,
            groundY: 500,
            roundTime: 99,
            maxEnergy: 100,
            energyPerHit: 10,
            specialCost: 50
        };

        // ==================== ËßíËâ≤ÈÖçÁΩÆ ====================
        const FIGHTERS = {
            p1: {
                color: '#ff4444',
                borderColor: '#cc0000',
                width: 60,
                height: 120,
                speed: 5,
                jumpForce: 15,
                damage: 15,
                specialDamage: 40
            },
            p2: {
                color: '#4444ff',
                borderColor: '#0000cc',
                width: 60,
                height: 120,
                speed: 5,
                jumpForce: 15,
                damage: 15,
                specialDamage: 40
            }
        };

        // ==================== Ê∏∏ÊàèÁä∂ÊÄÅ ====================
        let gameState = 'menu'; // menu, playing, paused, gameover
        let gameMode = 'pvp'; // pvp, ai
        let canvas, ctx;
        let player1, player2;
        let keys = {};
        let aiKeys = { left: false, right: false, jump: false, attack: false, special: false };
        let aiActionTimer = 0;
        let aiCurrentAction = 'idle';
        let timer = CONFIG.roundTime;
        let timerInterval;
        let roundWins = { p1: 0, p2: 0 };
        let animationFrame;

        // ==================== Fighter Á±ª ====================
        class Fighter {
            constructor(config, x, facing) {
                this.x = x;
                this.y = CONFIG.groundY - config.height;
                this.vx = 0;
                this.vy = 0;
                this.width = config.width;
                this.height = config.height;
                this.color = config.color;
                this.borderColor = config.borderColor;
                this.speed = config.speed;
                this.jumpForce = config.jumpForce;
                this.damage = config.damage;
                this.specialDamage = config.specialDamage;
                this.facing = facing; // 1 = right, -1 = left
                this.health = 100;
                this.energy = 0;
            this.isAttacking = false;
                this.isKicking = false;
                this.attackCooldown = 0;
                this.kickCooldown = 0;
                this.isGrounded = true;
                this.combo = 0;
                this.comboTimer = 0;
                this.hitStun = 0;
                this.isBlocking = false;
                this.attackType = null; // 'punch', 'kick', 'special'
            }

                // ÂÜ∑Âç¥ÈÄíÂáè
                if (this.attackCooldown > 0) this.attackCooldown--;
                if (this.kickCooldown > 0) this.kickCooldown--;
                if (this.comboTimer > 0) {
                    this.comboTimer--;
                    if (this.comboTimer === 0) this.combo = 0;
                }
                if (this.hitStun > 0) this.hitStun--;

                // ÁßªÂä®
                if (this.hitStun <= 0) {
                    if (keys.left) {
                        this.vx = -this.speed;
                        this.facing = -1;
                    } else if (keys.right) {
                        this.vx = this.speed;
                        this.facing = 1;
                    } else {
                        this.vx = 0;
                    }

                    // Èò≤Âæ°
                    this.isBlocking = (keys.left && this.facing === -1) || (keys.right && this.facing === 1);

                    // Ë∑≥Ë∑É
                    if (keys.jump && this.isGrounded) {
                        this.vy = -this.jumpForce;
                        this.isGrounded = false;
                    }
                }

                // ÈáçÂäõ
                this.vy += CONFIG.gravity;

                // Êõ¥Êñ∞‰ΩçÁΩÆ
                this.x += this.vx;
                this.y += this.vy;

                // Âú∞Èù¢Ê£ÄÊµã
                if (this.y > CONFIG.groundY - this.height) {
                    this.y = CONFIG.groundY - this.height;
                    this.vy = 0;
                    this.isGrounded = true;
                }

                // ËæπÁïåÊ£ÄÊµã
                if (this.x < 0) this.x = 0;
                if (this.x > CONFIG.canvasWidth - this.width) {
                    this.x = CONFIG.canvasWidth - this.width;
                }

                // Èù¢ÂêëÂØπÊâã
                if (opponent) {
                    this.facing = opponent.x > this.x ? 1 : -1;
                }
            }

                // ÈáçÂäõ
                this.vy += CONFIG.gravity;

                // Êõ¥Êñ∞‰ΩçÁΩÆ
                this.x += this.vx;
                this.y += this.vy;

                // Âú∞Èù¢Ê£ÄÊµã
                if (this.y > CONFIG.groundY - this.height) {
                    this.y = CONFIG.groundY - this.height;
                    this.vy = 0;
                    this.isGrounded = true;
                }

                // ËæπÁïåÊ£ÄÊµã
                if (this.x < 0) this.x = 0;
                if (this.x > CONFIG.canvasWidth - this.width) {
                    this.x = CONFIG.canvasWidth - this.width;
                }

                // Èù¢ÂêëÂØπÊâã
                if (opponent) {
                    this.facing = opponent.x > this.x ? 1 : -1;
                }
            }

            attack(opponent) {
                if (this.attackCooldown > 0 || this.hitStun > 0) return false;
                
                this.isAttacking = true;
                this.attackType = 'punch';
                this.attackCooldown = 20;
                this.hitStun = 8;
                
                setTimeout(() => {
                    this.isAttacking = false;
                    this.attackType = null;
                }, 150);

                // Ê£ÄÊµãÂëΩ‰∏≠
                if (this.checkHit(opponent, 80)) {
                    const damage = opponent.isBlocking ? this.damage * 0.2 : this.damage;
                    opponent.takeDamage(damage);
                    
                    // Ëé∑ÂæóËÉΩÈáè
                    this.energy = Math.min(CONFIG.maxEnergy, this.energy + CONFIG.energyPerHit);
                    
                    // ËøûÂáª
                    if (!opponent.isBlocking) {
                        this.combo++;
                        this.comboTimer = 60;
                        if (this.combo > 2) {
                            showCombo(this.combo);
                        }
                    }

                    return true;
                }
                return false;
            }
            
            kick(opponent) {
                if (this.kickCooldown > 0 || this.hitStun > 0) return false;
                
                this.isKicking = true;
                this.attackType = 'kick';
                this.kickCooldown = 25;
                this.hitStun = 12;
                
                setTimeout(() => {
                    this.isKicking = false;
                    this.attackType = null;
                }, 200);

                // Ë∏¢ËÖøÊîªÂáªËåÉÂõ¥Êõ¥Â§ß
                if (this.checkHit(opponent, 100)) {
                    const kickDamage = this.damage * 1.3; // Ë∏¢ËÖø‰º§ÂÆ≥Êõ¥È´ò
                    const damage = opponent.isBlocking ? kickDamage * 0.2 : kickDamage;
                    opponent.takeDamage(damage);
                    
                    this.energy = Math.min(CONFIG.maxEnergy, this.energy + CONFIG.energyPerHit);
                    
                    if (!opponent.isBlocking) {
                        this.combo++;
                        this.comboTimer = 60;
                        if (this.combo > 2) {
                            showCombo(this.combo);
                        }
                        // Ë∏¢ËÖøÂáªÈÄÄÊïàÊûú
                        opponent.x += this.facing * 20;
                    }

                    return true;
                }
                return false;
            }

            specialAttack(opponent) {
                if (this.attackCooldown > 0 || this.hitStun > 0) return false;
                if (this.energy < CONFIG.specialCost) return false;
                
                this.energy -= CONFIG.specialCost;
                this.isSpecial = true;
                this.attackCooldown = 30;
                this.hitStun = 10;
                
                setTimeout(() => {
                    this.isSpecial = false;
                }, 300);

                // ÂøÖÊùÄÊäÄÂ§ßËåÉÂõ¥ÂëΩ‰∏≠
                const attackRange = 150;
                const distance = Math.abs(this.x - opponent.x);
                
                if (distance < attackRange) {
                    opponent.takeDamage(this.specialDamage);
                    showCombo('SPECIAL');
                    return true;
                }
                return false;
            }

            checkHit(opponent, range = 80) {
                const attackRange = range;
                const distance = Math.abs(this.x - opponent.x);
                const heightDiff = Math.abs(this.y - opponent.y);
                
                return distance < attackRange && heightDiff < 60;
            }

            takeDamage(damage) {
                this.health = Math.max(0, this.health - damage);
                this.hitStun = 20;
            }

            draw(ctx) {
                const centerX = this.x + this.width / 2;
                const baseY = this.y;
                
                // ÂèóÂáªÈó™ÁôΩÊïàÊûú
                const baseColor = this.hitStun > 0 ? '#ffffff' : this.color;
                const skinColor = this.hitStun > 0 ? '#ffffff' : '#ffd5b5';
                
                // === ÁªòÂà∂Èò¥ÂΩ± ===
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.beginPath();
                ctx.ellipse(centerX, baseY + this.height + 3, 25, 8, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // === ËÖøÈÉ®Âä®Áîª ===
                const legOffset = Math.sin(Date.now() / 100) * (Math.abs(this.vx) > 0.5 ? 5 : 0);
                const kickExtend = this.isKicking ? this.facing * 40 : 0;
                
                // ÂêéËÖø
                ctx.fillStyle = '#1a2530';
                ctx.beginPath();
                ctx.moveTo(centerX - 8, baseY + 70);
                ctx.lineTo(centerX - 18 + (this.facing === 1 ? -legOffset : legOffset), baseY + 115);
                ctx.lineTo(centerX - 5, baseY + 115);
                ctx.lineTo(centerX - 5, baseY + 70);
                ctx.fill();
                
                // ÂâçËÖø (Ë∏¢ËÖøÊó∂‰º∏Âá∫)
                ctx.fillStyle = '#2c3e50';
                ctx.beginPath();
                ctx.moveTo(centerX + 8, baseY + 70);
                ctx.lineTo(centerX + 18 + kickExtend, baseY + 70);
                ctx.lineTo(centerX + 23 + kickExtend, baseY + 115);
                ctx.lineTo(centerX - 2 + kickExtend, baseY + 115);
                ctx.lineTo(centerX + 3, baseY + 70);
                ctx.fill();
                
                // ÈûãÂ≠ê
                ctx.fillStyle = '#0f1419';
                ctx.beginPath();
                ctx.ellipse(centerX + 10 + kickExtend, baseY + 112, 15, 6, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // === Ë∫´‰Ωì ===
                // Ë∫ØÂπ≤ (Êõ¥Á´ã‰ΩìÁöÑÂΩ¢Áä∂)
                ctx.fillStyle = baseColor;
                ctx.strokeStyle = this.borderColor;
                ctx.lineWidth = 2;
                
                ctx.beginPath();
                ctx.moveTo(centerX - 20, baseY + 30);
                ctx.quadraticCurveTo(centerX - 25, baseY + 50, centerX - 15, baseY + 75);
                ctx.lineTo(centerX + 15, baseY + 75);
                ctx.quadraticCurveTo(centerX + 25, baseY + 50, centerX + 20, baseY + 30);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                
                // Ë°£ÊúçÁªÜËäÇ
                ctx.strokeStyle = 'rgba(0,0,0,0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(centerX, baseY + 35);
                ctx.lineTo(centerX, baseY + 70);
                ctx.stroke();
                
                // ËÖ∞Â∏¶
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(centerX - 18, baseY + 68, 36, 8);
                ctx.strokeStyle = '#5D3A1A';
                ctx.strokeRect(centerX - 18, baseY + 68, 36, 8);
                
                // === ÊâãËáÇÂíåÊã≥Â§¥ ===
                const punchExtend = this.isAttacking ? this.facing * 45 : 0;
                const armAngle = this.isAttacking ? -0.3 : 0.2;
                
                // ÂêéËáÇ
                ctx.fillStyle = baseColor;
                ctx.beginPath();
                ctx.moveTo(centerX - 20, baseY + 35);
                ctx.quadraticCurveTo(centerX - 30, baseY + 50, centerX - 25, baseY + 65);
                ctx.lineTo(centerX - 15, baseY + 65);
                ctx.quadraticCurveTo(centerX - 20, baseY + 50, centerX - 12, baseY + 40);
                ctx.fill();
                ctx.strokeStyle = this.borderColor;
                ctx.stroke();
                
                // ÂâçËáÇ (Êã≥ÂáªÊó∂‰º∏Âá∫)
                ctx.fillStyle = baseColor;
                ctx.beginPath();
                ctx.moveTo(centerX + 20, baseY + 35);
                ctx.quadraticCurveTo(centerX + 35 + punchExtend, baseY + 40 + armAngle * 20, centerX + 40 + punchExtend, baseY + 50);
                ctx.lineTo(centerX + 35 + punchExtend, baseY + 60);
                ctx.quadraticCurveTo(centerX + 25 + punchExtend, baseY + 50, centerX + 15, baseY + 40);
                ctx.fill();
                ctx.stroke();
                
                // Êã≥Â§¥
                ctx.fillStyle = skinColor;
                ctx.beginPath();
                ctx.arc(centerX + 40 + punchExtend, baseY + 55, 10, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#e8c4a4';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // === Â§¥ÈÉ® ===
                const headX = centerX;
                const headY = baseY + 18;
                
                // ËÑñÂ≠ê
                ctx.fillStyle = skinColor;
                ctx.fillRect(centerX - 6, baseY + 20, 12, 12);
                
                // Â§¥ÂΩ¢
                ctx.fillStyle = skinColor;
                ctx.beginPath();
                ctx.ellipse(headX, headY, 18, 20, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#e8c4a4';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Â§¥Âèë (Ê†πÊçÆËßíËâ≤È¢úËâ≤)
                ctx.fillStyle = this.borderColor;
                ctx.beginPath();
                ctx.moveTo(headX - 18, headY - 5);
                ctx.quadraticCurveTo(headX - 15, headY - 25, headX, headY - 22);
                ctx.quadraticCurveTo(headX + 15, headY - 25, headX + 18, headY - 5);
                ctx.quadraticCurveTo(headX + 20, headY, headX + 18, headY + 5);
                ctx.lineTo(headX - 18, headY + 5);
                ctx.closePath();
                ctx.fill();
                
                // ÂèëÈôÖÁ∫ø
                ctx.strokeStyle = 'rgba(0,0,0,0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(headX - 12, headY - 10);
                ctx.quadraticCurveTo(headX, headY - 15, headX + 12, headY - 10);
                ctx.stroke();
                
                // ÁúºÁùõ
                const eyeOffsetX = this.facing * 5;
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.ellipse(headX + eyeOffsetX - 6, headY, 5, 4, 0, 0, Math.PI * 2);
                ctx.ellipse(headX + eyeOffsetX + 6, headY, 5, 4, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Áû≥Â≠î
                ctx.fillStyle = '#2c1810';
                ctx.beginPath();
                ctx.arc(headX + eyeOffsetX - 5 + this.facing, headY, 2.5, 0, Math.PI * 2);
                ctx.arc(headX + eyeOffsetX + 7 + this.facing, headY, 2.5, 0, Math.PI * 2);
                ctx.fill();
                
                // ÁúâÊØõ
                ctx.strokeStyle = this.borderColor;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(headX + eyeOffsetX - 10, headY - 6);
                ctx.quadraticCurveTo(headX + eyeOffsetX - 5, headY - 8, headX + eyeOffsetX - 2, headY - 6);
                ctx.moveTo(headX + eyeOffsetX + 10, headY - 6);
                ctx.quadraticCurveTo(headX + eyeOffsetX + 5, headY - 8, headX + eyeOffsetX + 2, headY - 6);
                ctx.stroke();
                
                // ÈºªÂ≠ê
                ctx.fillStyle = '#e8c4a4';
                ctx.beginPath();
                ctx.moveTo(headX + eyeOffsetX + 1, headY + 2);
                ctx.lineTo(headX + eyeOffsetX + 4, headY + 8);
                ctx.lineTo(headX + eyeOffsetX, headY + 6);
                ctx.closePath();
                ctx.fill();
                
                // Âò¥Â∑¥
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 2;
                ctx.beginPath();
                if (this.hitStun > 0) {
                    ctx.arc(headX + eyeOffsetX, headY + 12, 4, 0, Math.PI);
                } else if (this.isAttacking || this.isKicking) {
                    ctx.moveTo(headX + eyeOffsetX - 5, headY + 12);
                    ctx.lineTo(headX + eyeOffsetX + 5, headY + 12);
                } else {
                    ctx.arc(headX + eyeOffsetX, headY + 11, 3, 0.1 * Math.PI, 0.9 * Math.PI);
                }
                ctx.stroke();
                
                // === ÊîªÂáªÊïàÊûú ===
                if (this.isAttacking) {
                    // Êã≥ÂáªÂÜ≤ÂáªÊ≥¢
                    ctx.fillStyle = 'rgba(255, 200, 0, 0.6)';
                    ctx.strokeStyle = 'rgba(255, 150, 0, 0.8)';
                    ctx.lineWidth = 3;
                    const attackX = centerX + (this.facing === 1 ? 60 : -60);
                    ctx.beginPath();
                    ctx.arc(attackX, baseY + 55, 20, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // ÂÜ≤ÂáªÁ∫ø
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.lineWidth = 2;
                    for (let i = 0; i < 3; i++) {
                        ctx.beginPath();
                        ctx.moveTo(attackX - 15 + i * 5, baseY + 40);
                        ctx.lineTo(attackX + 15 + i * 5, baseY + 70);
                        ctx.stroke();
                    }
                }
                
                if (this.isKicking) {
                    // Ë∏¢ËÖøÂÜ≤ÂáªÊ≥¢
                    ctx.fillStyle = 'rgba(0, 255, 200, 0.6)';
                    ctx.strokeStyle = 'rgba(0, 200, 150, 0.8)';
                    ctx.lineWidth = 3;
                    const kickX = centerX + (this.facing === 1 ? 70 : -70);
                    ctx.beginPath();
                    ctx.arc(kickX, baseY + 110, 25, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                }
                
                if (this.isSpecial) {
                    // ÂøÖÊùÄÊäÄÊïàÊûú
                    const specialX = centerX + (this.facing === 1 ? 80 : -80);
                    
                    // ËÉΩÈáèÁêÉ
                    ctx.fillStyle = 'rgba(255, 50, 150, 0.8)';
                    ctx.beginPath();
                    ctx.arc(specialX, baseY + 60, 50, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ËÉΩÈáèÊ≥¢Á∫π
                    ctx.strokeStyle = 'rgba(255, 100, 200, 0.9)';
                    ctx.lineWidth = 4;
                    for (let i = 0; i < 3; i++) {
                        ctx.beginPath();
                        ctx.arc(specialX, baseY + 60, 60 + i * 15, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                    
                    // ÂÖâËäí
                    ctx.strokeStyle = 'rgba(255, 200, 255, 0.7)';
                    ctx.lineWidth = 2;
                    for (let i = 0; i < 8; i++) {
                        const angle = (i / 8) * Math.PI * 2;
                        ctx.beginPath();
                        ctx.moveTo(specialX + Math.cos(angle) * 30, baseY + 60 + Math.sin(angle) * 30);
                        ctx.lineTo(specialX + Math.cos(angle) * 70, baseY + 60 + Math.sin(angle) * 70);
                        ctx.stroke();
                    }
                }
                
                // Èò≤Âæ°ÊïàÊûú
                if (this.isBlocking) {
                    ctx.fillStyle = 'rgba(100, 200, 255, 0.3)';
                    ctx.strokeStyle = 'rgba(100, 200, 255, 0.8)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.ellipse(centerX, baseY + 60, 35, 55, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                }
            }
        }

        // ==================== Ê∏∏ÊàèÂàùÂßãÂåñ ====================
        function init() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');

            // Á°Æ‰øù canvas ‰ΩøÁî®Âõ∫ÂÆöÂ∞∫ÂØ∏Ôºà‰∏çËøõË°åÁº©ÊîæÔºâ
            // ÁßªÂä®Á´ØÈÄÇÈÖçÈÄöËøá CSS ÂÆûÁé∞ÔºåËÄå‰∏çÊòØÁº©Êîæ canvas ÂÜÖÂÆπ
            canvas.width = CONFIG.canvasWidth;
            canvas.height = CONFIG.canvasHeight;

            // ÁßªÂä®Á´ØÔºöÈÄöËøá CSS Áº©ÊîæÊï¥‰∏™ canvasÔºåËÄå‰∏çÊòØÁº©ÊîæÂÜÖÂÆπ
            if (window.innerWidth <= 768) {
                const scale = Math.min(
                    (window.innerWidth - 40) / CONFIG.canvasWidth,
                    (window.innerHeight - 300) / CONFIG.canvasHeight
                );
                canvas.style.width = (CONFIG.canvasWidth * scale) + 'px';
                canvas.style.height = (CONFIG.canvasHeight * scale) + 'px';
            } else {
                canvas.style.width = CONFIG.canvasWidth + 'px';
                canvas.style.height = CONFIG.canvasHeight + 'px';
            }

            resetPlayers();
            setupEventListeners();
            showControlsHelp();
        }

        function resetPlayers() {
            player1 = new Fighter(FIGHTERS.p1, 100, 1);
            player2 = new Fighter(FIGHTERS.p2, CONFIG.canvasWidth - 160, -1);
        }

        function setupEventListeners() {
            window.addEventListener('keydown', (e) => {
                keys[e.key.toLowerCase()] = true;
                keys[e.code] = true;
            });

            window.addEventListener('keyup', (e) => {
                keys[e.key.toLowerCase()] = false;
                keys[e.code] = false;
            });

            setupMobileControls();
        }

        // ==================== ÁßªÂä®Á´ØÊéßÂà∂ ====================
        function setupMobileControls() {
            const joystick = document.getElementById('joystick');
            const joystickKnob = document.getElementById('joystickKnob');
            const actionButtons = document.querySelectorAll('.action-btn');

            // ËôöÊãüÊëáÊùÜÊéßÂà∂
            let joystickActive = false;
            const joystickCenter = { x: 60, y: 60 };

            joystick.addEventListener('touchstart', (e) => {
                joystickActive = true;
                handleJoystickTouch(e.touches[0]);
            });

            joystick.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (joystickActive) {
                    handleJoystickTouch(e.touches[0]);
                }
            });

            joystick.addEventListener('touchend', (e) => {
                joystickActive = false;
                resetJoystick();
            });

            function handleJoystickTouch(touch) {
                const rect = joystick.getBoundingClientRect();
                const touchX = touch.clientX - rect.left - joystickCenter.x;
                const touchY = touch.clientY - rect.top - joystickCenter.y;

                const maxMove = 35;
                const distance = Math.min(Math.sqrt(touchX * touchX + touchY * touchY), maxMove);
                const angle = Math.atan2(touchY, touchX);

                const knobX = Math.cos(angle) * distance;
                const knobY = Math.sin(angle) * distance;

                joystickKnob.style.transform = `translate(calc(-50% + ${knobX}px), calc(-50% + ${knobY}px))`;

                // Êò†Â∞ÑÂà∞Ê∏∏ÊàèÊåâÈîÆ
                if (distance > 10) {
                    if (Math.abs(knobX) > Math.abs(knobY)) {
                        keys['a'] = knobX < 0;
                        keys['d'] = knobX > 0;
                        keys['w'] = false;
                    } else {
                        keys['w'] = knobY < 0;
                        keys['a'] = false;
                        keys['d'] = false;
                    }
                }
            }

            function resetJoystick() {
                joystickKnob.style.transform = 'translate(-50%, -50%)';
                keys['w'] = keys['a'] = keys['d'] = false;
            }

            // Âä®‰ΩúÊåâÈíÆÊéßÂà∂
            actionButtons.forEach(btn => {
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const action = btn.dataset.action;
                    handleAction(action, true);
                });

                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    const action = btn.dataset.action;
                    handleAction(action, false);
                });
            });
        }

        function handleAction(action, active) {
            switch(action) {
                case 'jump':
                    keys['w'] = active;
                    break;
                case 'attack':
                    keys['j'] = active;
                    break;
                case 'attack2':
                    keys['k'] = active;
                    break;
                case 'special':
                    keys['l'] = active;
                    break;
            }
        }

        function showControlsHelp() {
            const helpKeys = `
            P1 ÊéßÂà∂:
            - W: Ë∑≥Ë∑É
            - A: Â∑¶Áßª
            - D: Âè≥Áßª
            - S: Ëπ≤‰∏ã
            - J: Êã≥ÊîªÂáª
            - K: ËÑöÊîªÂáª
            - L: ÂøÖÊùÄÊäÄ
            
            P2 ÊéßÂà∂:
            - ‚Üë: Ë∑≥Ë∑É
            - ‚Üê: Â∑¶Áßª
            - ‚Üí: Âè≥Áßª
            - ‚Üì: Ëπ≤‰∏ã
            - 1: Êã≥ÊîªÂáª
            - 2: ËÑöÊîªÂáª
            - 3: ÂøÖÊùÄÊäÄ
            
            ÊèêÁ§∫:
            - ÁßªÂä®‰∏≠ÊåâÁõ∏ÂèçÊñπÂêëÂèØ‰ª•Èò≤Âæ°
            - ÂøÖÊùÄÊäÄÈúÄË¶ÅËÉΩÈáèÊª°‰∏ÄÂçä
            - ËøûÁª≠ÊîªÂáªËß¶ÂèëËøûÂáª`;
            
            alert(helpKeys);
        }

        // ==================== Ê∏∏ÊàèÂæ™ÁéØ ====================
        function gameLoop() {
            if (gameState !== 'playing') return;

            update();
            draw();
            animationFrame = requestAnimationFrame(gameLoop);
        }

        function update() {
            // P1 ÊåâÈîÆÊò†Â∞Ñ
            const p1Keys = {
                left: keys['a'],
                right: keys['d'],
                jump: keys['w'],
                attack: keys['j'],
                kick: keys['k'],
                special: keys['l']
            };

            // P2 ÊåâÈîÆÊò†Â∞Ñ
            let p2Keys = {
                left: keys['arrowleft'],
                right: keys['arrowright'],
                jump: keys['arrowup'],
                attack: keys['digit1'] || keys['numpad1'],
                kick: keys['digit2'] || keys['numpad2'],
                special: keys['digit3'] || keys['numpad3']
            };

            // AI ÂØπÊàòÊ®°Âºè
            if (gameMode === 'ai') {
                updateAI(player2, player1);
                p2Keys = getAIKeys();
            }

            // Êõ¥Êñ∞ËßíËâ≤
            player1.update(p1Keys, player2);
            player2.update(p2Keys, player1);

            // Â§ÑÁêÜÊîªÂáª
            if (p1Keys.attack) player1.attack(player2);
            if (p2Keys.attack) player2.attack(player1);
            if (p1Keys.kick) player1.kick(player2);
            if (p2Keys.kick) player2.kick(player1);
            if (p1Keys.special) player1.specialAttack(player2);
            if (p2Keys.special) player2.specialAttack(player1);

            // Êõ¥Êñ∞UI
            updateHUD();

            // Ê£ÄÊü•Ê∏∏ÊàèÁªìÊùü
            checkGameOver();
        }
            // Êõ¥Êñ∞UI
            updateHUD();

            // Ê£ÄÊü•Ê∏∏ÊàèÁªìÊùü
            checkGameOver();
        }

        function draw() {
            // Ê∏ÖÁ©∫ÁîªÂ∏É
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ÁªòÂà∂ËÉåÊôØÔºàÂú∞Èù¢Ôºâ
            const gradient = ctx.createLinearGradient(0, CONFIG.groundY - 100, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(0.7, '#98FB98');
            gradient.addColorStop(1, '#8B4513');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ÁªòÂà∂Âú∞Èù¢
            ctx.fillStyle = '#654321';
            ctx.fillRect(0, CONFIG.groundY, canvas.width, canvas.height - CONFIG.groundY);
            ctx.fillStyle = '#7EC850';
            ctx.fillRect(0, CONFIG.groundY, canvas.width, 10);

            // ÁªòÂà∂ËßíËâ≤
            player1.draw(ctx);
            player2.draw(ctx);
        }

        function updateHUD() {
            document.getElementById('healthP1').style.width = player1.health + '%';
            document.getElementById('healthP2').style.width = player2.health + '%';
            document.getElementById('energyP1').style.width = player1.energy + '%';
            document.getElementById('energyP2').style.width = player2.energy + '%';
            document.getElementById('timer').textContent = timer;
        }

        function showCombo(combo) {
            if (typeof combo === 'string') {
                showComboText('SPECIAL!');
            } else {
                showComboText(combo + ' HITS!');
            }
        }

        function showComboText(text) {
            const existing = document.querySelector('.combo-display');
            if (existing) existing.remove();

            const comboEl = document.createElement('div');
            comboEl.className = 'combo-display';
            comboEl.textContent = text;
            document.body.appendChild(comboEl);

            setTimeout(() => {
                comboEl.remove();
            }, 1000);
        }

        function checkGameOver() {
            if (player1.health <= 0 || player2.health <= 0) {
                if (player1.health <= 0) {
                    roundWins.p2++;
                } else {
                    roundWins.p1++;
                }

                if (roundWins.p1 >= 2 || roundWins.p2 >= 2) {
                    endGame();
                } else {
                    nextRound();
                }
            } else if (timer <= 0) {
                // Êó∂Èó¥Âà∞ÔºåË°ÄÈáèÂ§öÁöÑËé∑ËÉú
                if (player1.health > player2.health) {
                    roundWins.p1++;
                } else if (player2.health > player1.health) {
                    roundWins.p2++;
                } else {
                    // Âπ≥Â±ÄÔºåÈöèÊú∫
                    if (Math.random() > 0.5) {
                        roundWins.p1++;
                    } else {
                        roundWins.p2++;
                    }
                }

                if (roundWins.p1 >= 2 || roundWins.p2 >= 2) {
                    endGame();
                } else {
                    nextRound();
                }
            }
        }

        function nextRound() {
            clearInterval(timerInterval);
            cancelAnimationFrame(animationFrame);
            
            // ÈáçÁΩÆÁä∂ÊÄÅ
            resetPlayers();
            timer = CONFIG.roundTime;
            gameState = 'paused';

            const winner = roundWins.p1 > roundWins.p2 ? 'Player 1' : 'Player 2';
            setTimeout(() => {
                alert(`Á¨¨ ${roundWins.p1 + roundWins.p2} ÂõûÂêàÁªìÊùü!\nÂΩìÂâçÊØîÂàÜ: ${roundWins.p1} - ${roundWins.p2}`);
                startRound();
            }, 500);
        }

        function endGame() {
            clearInterval(timerInterval);
            cancelAnimationFrame(animationFrame);
            gameState = 'gameover';

            const winner = roundWins.p1 >= 2 ? 'Player 1' : 'Player 2';
            document.getElementById('winnerText').textContent = winner + ' Ëé∑ËÉú!';
            document.getElementById('scoreText').textContent = `ÊúÄÁªàÊØîÂàÜ: ${roundWins.p1} - ${roundWins.p2}`;
            document.getElementById('gameOver').style.display = 'flex';
        }

        // ==================== Ê∏∏ÊàèÊéßÂà∂ ====================
        function startGame(mode) {
            gameMode = mode || 'pvp';
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('visible');

            roundWins = { p1: 0, p2: 0 };
            startRound();
        }

        function startRound() {
            gameState = 'playing';
            resetPlayers();
            timer = CONFIG.roundTime;
            
            // ÂºÄÂßãËÆ°Êó∂Âô®
            timerInterval = setInterval(() => {
                timer--;
                if (timer <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);

            // ÂºÄÂßãÊ∏∏ÊàèÂæ™ÁéØ
            gameLoop();
        }

        function restartGame() {
            document.getElementById('gameOver').style.display = 'none';
            startGame();
        }

        function goToMenu() {
            clearInterval(timerInterval);
            cancelAnimationFrame(animationFrame);
            gameState = 'menu';

            // Ë∑≥ËΩ¨Âà∞‰∏ªÈ°µ
            window.location.href = '../../index.html';
        }

        function showControls() {
            showControlsHelp();
        }

        // ==================== AI ÂØπÊàòÁ≥ªÁªü ====================
        function updateAI(aiPlayer, humanPlayer) {
            aiActionTimer--;

            const distance = Math.abs(aiPlayer.x - humanPlayer.x);
            const isFacingHuman = (aiPlayer.facing === 1 && humanPlayer.x > aiPlayer.x) ||
                                 (aiPlayer.facing === -1 && humanPlayer.x < aiPlayer.x);

            // AI ÂÜ≥Á≠ñÈÄªËæë
            if (aiActionTimer <= 0) {
                // ÈáçÁΩÆAIÊìç‰Ωú
                aiKeys = { left: false, right: false, jump: false, attack: false, kick: false, special: false };

                // Ê†πÊçÆË∑ùÁ¶ªÂÜ≥ÂÆöË°åÂä®
                if (distance > 150) {
                    // Èù†ËøëÂØπÊâã
                    aiCurrentAction = 'approach';
                    aiKeys.right = humanPlayer.x > aiPlayer.x;
                    aiKeys.left = humanPlayer.x < aiPlayer.x;
                    aiActionTimer = 20;
                } else if (distance < 80 && isFacingHuman) {
                    // ÊîªÂáªËåÉÂõ¥
                    const randomAction = Math.random();
                    if (aiPlayer.energy >= 50 && randomAction < 0.15) {
                        aiCurrentAction = 'special';
                        aiKeys.special = true;
                        aiActionTimer = 10;
                    } else if (randomAction < 0.4) {
                        aiCurrentAction = 'attack';
                        aiKeys.attack = true;
                        aiActionTimer = 15;
                    } else if (randomAction < 0.65) {
                        aiCurrentAction = 'kick';
                        aiKeys.kick = true;
                        aiActionTimer = 18;
                    } else {
                        aiCurrentAction = 'retreat';
                        aiKeys.left = humanPlayer.x > aiPlayer.x;
                        aiKeys.right = humanPlayer.x < aiPlayer.x;
                        aiActionTimer = 15;
                    }
                } else {
                    // ‰∏≠Á≠âË∑ùÁ¶ªÔºåÈÄâÊã©Èù†ËøëÊàñË∑≥Ë∑É
                    const randomAction = Math.random();
                    if (randomAction < 0.6) {
                        aiCurrentAction = 'approach';
                        aiKeys.right = humanPlayer.x > aiPlayer.x;
                        aiKeys.left = humanPlayer.x < aiPlayer.x;
                        aiActionTimer = 15;
                    } else {
                        aiCurrentAction = 'jump';
                        aiKeys.jump = true;
                        aiActionTimer = 10;
                    }
                }

                // Èò≤Âæ°ÂÜ≥Á≠ñ
                if ((humanPlayer.isAttacking || humanPlayer.isKicking) && distance < 100 && Math.random() < 0.5) {
                    aiKeys.right = humanPlayer.x > aiPlayer.x;
                    aiKeys.left = humanPlayer.x < aiPlayer.x;
                }
            }
            }
        }

        function getAIKeys() {
            return aiKeys;
        }

        // ==================== ÂêØÂä®Ê∏∏Êàè ====================
        window.onload = init;
    </script>
</body>
</html>
