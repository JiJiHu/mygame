<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¥Š æ‹³çš‡æ ¼æ–—</title>
    <link rel="stylesheet" href="../onepiece-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .close-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e94560;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            color: #e94560;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #e94560;
            color: white;
            transform: rotate(90deg);
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ä¸»èœå• */
        .menu-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 20px;
        }

        .menu-title {
            font-size: 72px;
            font-weight: bold;
            color: #ff6b35;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.8),
                         0 0 40px rgba(255, 107, 53, 0.6),
                         4px 4px 0 #1a1a2e,
                         8px 8px 0 #16213e;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .menu-subtitle {
            font-size: 28px;
            color: #ffffff;
            margin-bottom: 60px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .menu-btn {
            display: block;
            width: 280px;
            padding: 20px 40px;
            margin: 15px;
            font-size: 22px;
            font-weight: bold;
            color: white;
            background: linear-gradient(145deg, #e94560, #d63447);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 0 #a02030,
                        0 10px 30px rgba(233, 69, 96, 0.4);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .menu-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #a02030,
                        0 15px 40px rgba(233, 69, 96, 0.5);
        }

        .menu-btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 0 #a02030,
                        0 5px 15px rgba(233, 69, 96, 0.4);
        }

        .menu-btn.secondary {
            background: linear-gradient(145deg, #0f3460, #16213e);
            box-shadow: 0 6px 0 #0a213a,
                        0 10px 30px rgba(15, 52, 96, 0.4);
        }

        .menu-btn.secondary:hover {
            box-shadow: 0 9px 0 #0a213a,
                        0 15px 40px rgba(15, 52, 96, 0.5);
        }

        /* æ¸¸æˆç•Œé¢ */
        .game-screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
        }

        .hud {
            width: 90%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 20px;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .player-info {
            width: 45%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-name {
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .health-bar-container {
            width: 100%;
            height: 30px;
            background: #2d2d44;
            border: 3px solid #444;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .health-bar {
            height: 100%;
            transition: width 0.3s;
            border-radius: 3px;
        }

        .health-bar.p1 {
            background: linear-gradient(90deg, #ff4444, #ff6b6b);
            margin-left: auto;
        }

        .health-bar.p2 {
            background: linear-gradient(90deg, #4444ff, #6b6bff);
        }

        .energy-container {
            width: 100%;
            height: 15px;
            background: #2d2d44;
            border: 2px solid #444;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }

        .energy-bar {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4a);
            transition: width 0.2s;
        }

        .timer {
            font-size: 48px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8),
                         2px 2px 4px rgba(0, 0, 0, 0.8);
            min-width: 80px;
            text-align: center;
        }

        .timer-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            font-size: 20px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-btn:hover {
            background: rgba(233, 69, 96, 0.8);
            border-color: rgba(233, 69, 96, 1);
            transform: scale(1.1);
        }

        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: relative;
        }

        #gameCanvas {
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 70%, #8B4513 100%);
            border: 4px solid #2d2d44;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 72px;
            font-weight: bold;
            color: #ff6b35;
            text-shadow: 3px 3px 0 #1a1a2e,
                         6px 6px 0 #16213e;
            animation: comboPopup 0.5s;
            pointer-events: none;
        }

        @keyframes comboPopup {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .game-over h1 {
            font-size: 64px;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .game-over p {
            font-size: 28px;
            color: white;
            margin-bottom: 40px;
        }

        /* å¸®åŠ©é¢æ¿ */
        .controls-help {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .help-row {
            display: flex;
            align-items: center;
            margin: 5px 0;
            gap: 20px;
        }

        .help-player {
            font-weight: bold;
            min-width: 60px;
        }

        .help-player.p1 { color: #ff6b6b; }
        .help-player.p2 { color: #6b6bff; }

        .help-keys {
            display: flex;
            gap: 5px;
        }

        .key {
            background: #444;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: monospace;
            border: 1px solid #666;
        }

        /* éšè—/æ˜¾ç¤ºæ§åˆ¶ */
        .hidden { display: none !important; }
        .visible { display: flex !important; }

        /* ç§»åŠ¨ç«¯è™šæ‹Ÿæ§åˆ¶ */
        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
        }

        @media (max-width: 768px) {
            .mobile-controls {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .controls-help {
                display: none;
            }

            .game-container {
                padding-bottom: 180px;
            }

            #gameCanvas {
                max-width: 100%;
                height: auto;
            }

            .menu-title {
                font-size: 36px;
            }

            .menu-subtitle {
                font-size: 18px;
            }

            .menu-btn {
                width: 240px;
                font-size: 18px;
                padding: 15px 30px;
            }

            .hud {
                padding: 10px;
                font-size: 12px;
            }

            .player-name {
                font-size: 16px;
            }

            .health-bar-container {
                height: 20px;
            }

            .timer {
                font-size: 32px;
            }
        }

        .joystick-container {
            width: 120px;
            height: 120px;
        }

        .joystick {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            position: relative;
        }

        .joystick-knob {
            width: 50px;
            height: 50px;
            background: rgba(255, 107, 53, 0.8);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.8);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            transition: all 0.1s;
        }

        .action-btn:active {
            background: rgba(255, 107, 53, 0.8);
            transform: scale(0.95);
            border-color: rgba(255, 107, 53, 1);
        }

        .btn-jump {
            background: rgba(0, 255, 135, 0.5);
        }

        .btn-jump:active {
            background: rgba(0, 255, 135, 0.8);
        }

        .btn-attack {
            background: rgba(255, 0, 135, 0.5);
        }

        .btn-attack:active {
            background: rgba(255, 0, 135, 0.8);
        }

        .btn-special {
            background: rgba(255, 215, 0, 0.5);
        }

        .btn-special:active {
            background: rgba(255, 215, 0, 0.8);
        }
    </style>
</head>
<body>
    <button class="close-btn" onclick="goToMenu()" title="è¿”å›èœå•">Ã—</button>

    <!-- ä¸»èœå• -->
    <div id="menuScreen" class="menu-screen">
        <h1 class="menu-title">ğŸ¥Š æ‹³çš‡æ ¼æ–—</h1>
        <p class="menu-subtitle">ç»å…¸æ ¼æ–—ï¼Œçƒ­è¡€å¯¹å†³</p>
        <button class="menu-btn" onclick="startGame('pvp')">åŒäººå¯¹æˆ˜</button>
        <button class="menu-btn" onclick="startGame('ai')">AI å¯¹æˆ˜</button>
        <button class="menu-btn secondary" onclick="showControls()">æ“ä½œè¯´æ˜</button>
    </div>

    <!-- æ¸¸æˆç•Œé¢ -->
    <div id="gameScreen" class="game-screen hidden">
        <div class="hud">
            <div class="player-info">
                <div class="player-name">PLAYER 1</div>
                <div class="health-bar-container">
                    <div id="healthP1" class="health-bar p1" style="width: 100%"></div>
                </div>
                <div class="energy-container">
                    <div id="energyP1" class="energy-bar" style="width: 0%"></div>
                </div>
            </div>

            <div class="timer-section">
                <button class="back-btn" onclick="goToMenu()" title="è¿”å›èœå•">â†</button>
                <div class="timer" id="timer">99</div>
            </div>

            <div class="player-info">
                <div class="player-name">PLAYER 2</div>
                <div class="health-bar-container">
                    <div id="healthP2" class="health-bar p2" style="width: 100%"></div>
                </div>
                <div class="energy-container">
                    <div id="energyP2" class="energy-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="gameCanvas"></canvas>
        </div>

        <div class="controls-help">
            <div class="help-row">
                <span class="help-player p1">P1:</span>
                <div class="help-keys">
                    <span class="key">WASD</span> ç§»åŠ¨
                    <span class="key">J</span> æ‹³
                    <span class="key">K</span> è„š
                    <span class="key">L</span> å¿…æ€
                </div>
            </div>
            <div class="help-row">
                <span class="help-player p2">P2:</span>
                <div class="help-keys">
                    <span class="key">â†‘â†“â†â†’</span> ç§»åŠ¨
                    <span class="key">1</span> æ‹³
                    <span class="key">2</span> è„š
                    <span class="key">3</span> å¿…æ€
                </div>
            </div>
        </div>

        <!-- ç§»åŠ¨ç«¯è™šæ‹Ÿæ§åˆ¶ -->
        <div class="mobile-controls" id="mobileControls">
            <div class="joystick-container">
                <div class="joystick" id="joystick">
                    <div class="joystick-knob" id="joystickKnob"></div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn btn-jump" data-action="jump">â†‘</button>
                <button class="action-btn btn-attack" data-action="attack">ğŸ‘Š</button>
                <button class="action-btn btn-attack" data-action="attack2">ğŸ¦¶</button>
                <button class="action-btn btn-special" data-action="special">âš¡</button>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆç»“æŸ -->
    <div id="gameOver" class="game-over">
        <h1 id="winnerText">PLAYE R1 è·èƒœ!</h1>
        <p id="scoreText">æ¯”åˆ† 2 - 1</p>
        <button class="menu-btn" onclick="restartGame()">å†æ¥ä¸€å±€</button>
        <button class="menu-btn secondary" onclick="goToMenu()">è¿”å›èœå•</button>
    </div>

    <script>
        // ==================== æ¸¸æˆé…ç½® ====================
        const CONFIG = {
            canvasWidth: 1000,
            canvasHeight: 600,
            gravity: 0.8,
            groundY: 500,
            roundTime: 99,
            maxEnergy: 100,
            energyPerHit: 10,
            specialCost: 50
        };

        // ==================== è§’è‰²é…ç½® ====================
        const FIGHTERS = {
            p1: {
                color: '#ff4444',
                borderColor: '#cc0000',
                width: 60,
                height: 120,
                speed: 5,
                jumpForce: 15,
                damage: 15,
                specialDamage: 40
            },
            p2: {
                color: '#4444ff',
                borderColor: '#0000cc',
                width: 60,
                height: 120,
                speed: 5,
                jumpForce: 15,
                damage: 15,
                specialDamage: 40
            }
        };

        // ==================== æ¸¸æˆçŠ¶æ€ ====================
        let gameState = 'menu'; // menu, playing, paused, gameover
        let gameMode = 'pvp'; // pvp, ai
        let canvas, ctx;
        let player1, player2;
        let keys = {};
        let aiKeys = { left: false, right: false, jump: false, attack: false, special: false };
        let aiActionTimer = 0;
        let aiCurrentAction = 'idle';
        let timer = CONFIG.roundTime;
        let timerInterval;
        let roundWins = { p1: 0, p2: 0 };
        let animationFrame;

        // ==================== Fighter ç±» ====================
        class Fighter {
            constructor(config, x, facing) {
                this.x = x;
                this.y = CONFIG.groundY - config.height;
                this.vx = 0;
                this.vy = 0;
                this.width = config.width;
                this.height = config.height;
                this.color = config.color;
                this.borderColor = config.borderColor;
                this.speed = config.speed;
                this.jumpForce = config.jumpForce;
                this.damage = config.damage;
                this.specialDamage = config.specialDamage;
                this.facing = facing; // 1 = right, -1 = left
                this.health = 100;
                this.energy = 0;
                this.isAttacking = false;
                this.isSpecial = false;
                this.attackCooldown = 0;
                this.isGrounded = true;
                this.combo = 0;
                this.comboTimer = 0;
                this.hitStun = 0;
                this.isBlocking = false;
            }

            update(keys, opponent) {
                // å†·å´é€’å‡
                if (this.attackCooldown > 0) this.attackCooldown--;
                if (this.comboTimer > 0) {
                    this.comboTimer--;
                    if (this.comboTimer === 0) this.combo = 0;
                }
                if (this.hitStun > 0) this.hitStun--;

                // ç§»åŠ¨
                if (this.hitStun <= 0) {
                    if (keys.left) {
                        this.vx = -this.speed;
                        this.facing = -1;
                    } else if (keys.right) {
                        this.vx = this.speed;
                        this.facing = 1;
                    } else {
                        this.vx = 0;
                    }

                    // é˜²å¾¡
                    this.isBlocking = (keys.left && this.facing === -1) || (keys.right && this.facing === 1);

                    // è·³è·ƒ
                    if (keys.jump && this.isGrounded) {
                        this.vy = -this.jumpForce;
                        this.isGrounded = false;
                    }
                }

                // é‡åŠ›
                this.vy += CONFIG.gravity;

                // æ›´æ–°ä½ç½®
                this.x += this.vx;
                this.y += this.vy;

                // åœ°é¢æ£€æµ‹
                if (this.y > CONFIG.groundY - this.height) {
                    this.y = CONFIG.groundY - this.height;
                    this.vy = 0;
                    this.isGrounded = true;
                }

                // è¾¹ç•Œæ£€æµ‹
                if (this.x < 0) this.x = 0;
                if (this.x > CONFIG.canvasWidth - this.width) {
                    this.x = CONFIG.canvasWidth - this.width;
                }

                // é¢å‘å¯¹æ‰‹
                if (opponent) {
                    this.facing = opponent.x > this.x ? 1 : -1;
                }
            }

            attack(opponent) {
                if (this.attackCooldown > 0 || this.hitStun > 0) return false;
                
                this.isAttacking = true;
                this.attackCooldown = 15;
                this.hitStun = 5;
                
                setTimeout(() => {
                    this.isAttacking = false;
                }, 100);

                // æ£€æµ‹å‘½ä¸­
                if (this.checkHit(opponent)) {
                    const damage = opponent.isBlocking ? this.damage * 0.2 : this.damage;
                    opponent.takeDamage(damage);
                    
                    // è·å¾—èƒ½é‡
                    this.energy = Math.min(CONFIG.maxEnergy, this.energy + CONFIG.energyPerHit);
                    
                    // è¿å‡»
                    if (!opponent.isBlocking) {
                        this.combo++;
                        this.comboTimer = 60;
                        if (this.combo > 2) {
                            showCombo(this.combo);
                        }
                    }

                    return true;
                }
                return false;
            }

            specialAttack(opponent) {
                if (this.attackCooldown > 0 || this.hitStun > 0) return false;
                if (this.energy < CONFIG.specialCost) return false;
                
                this.energy -= CONFIG.specialCost;
                this.isSpecial = true;
                this.attackCooldown = 30;
                this.hitStun = 10;
                
                setTimeout(() => {
                    this.isSpecial = false;
                }, 300);

                // å¿…æ€æŠ€å¤§èŒƒå›´å‘½ä¸­
                const attackRange = 150;
                const distance = Math.abs(this.x - opponent.x);
                
                if (distance < attackRange) {
                    opponent.takeDamage(this.specialDamage);
                    showCombo('SPECIAL');
                    return true;
                }
                return false;
            }

            checkHit(opponent) {
                const attackRange = 80;
                const distance = Math.abs(this.x - opponent.x);
                const heightDiff = Math.abs(this.y - opponent.y);
                
                return distance < attackRange && heightDiff < 50;
            }

            takeDamage(damage) {
                this.health = Math.max(0, this.health - damage);
                this.hitStun = 20;
            }

            draw(ctx) {
                const centerX = this.x + this.width / 2;
                const centerY = this.y + this.height / 2;

                // å—å‡»é—ªç™½æ•ˆæœ
                const baseColor = this.hitStun > 0 ? '#ffffff' : this.color;

                // è£¤å­ (ä¸‹åŠèº«)
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(this.x + 15, this.y + 75, 30, 45);
                ctx.strokeStyle = '#1a1a2e';
                ctx.lineWidth = 2;
                ctx.strokeRect(this.x + 15, this.y + 75, 30, 45);

                // ä¸Šèº«
                ctx.fillStyle = baseColor;
                ctx.strokeStyle = this.borderColor;
                ctx.lineWidth = 3;
                ctx.fillRect(this.x + 10, this.y + 30, 40, 50);
                ctx.strokeRect(this.x + 10, this.y + 30, 40, 50);

                // è¡£æœçº¿æ¡
                ctx.strokeStyle = this.borderColor;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(centerX, this.y + 30);
                ctx.lineTo(centerX, this.y + 75);
                ctx.stroke();

                // å¤´éƒ¨ (æ›´çœŸå®çš„äººè„¸)
                const headX = centerX;
                const headY = this.y + 20;
                const headRadius = 22;

                // å¤´å½¢
                ctx.fillStyle = '#ffd5b5';
                ctx.beginPath();
                ctx.arc(headX, headY, headRadius, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#e8c4a4';
                ctx.lineWidth = 2;
                ctx.stroke();

                // å¤´å‘ (æ ¹æ®è§’è‰²é¢œè‰²)
                ctx.fillStyle = this.borderColor;
                ctx.beginPath();
                ctx.arc(headX, headY - 5, headRadius * 0.9, Math.PI, 2 * Math.PI);
                ctx.fill();

                // çœ¼ç›
                const eyeOffset = this.facing * 6;
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(headX + eyeOffset - 5, headY - 2, 3, 0, Math.PI * 2);
                ctx.arc(headX + eyeOffset + 5, headY - 2, 3, 0, Math.PI * 2);
                ctx.fill();

                // çœ‰æ¯›
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(headX + eyeOffset - 9, headY - 8);
                ctx.lineTo(headX + eyeOffset - 1, headY - 7);
                ctx.moveTo(headX + eyeOffset + 9, headY - 8);
                ctx.lineTo(headX + eyeOffset + 1, headY - 7);
                ctx.stroke();

                // é¼»å­
                ctx.fillStyle = '#d4a574';
                ctx.beginPath();
                ctx.moveTo(headX + eyeOffset + 2, headY + 2);
                ctx.lineTo(headX + eyeOffset + 4, headY + 5);
                ctx.lineTo(headX + eyeOffset, headY + 5);
                ctx.fill();

                // å˜´å·´ï¼ˆæ ¹æ®çŠ¶æ€å˜åŒ–ï¼‰
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.beginPath();
                if (this.hitStun > 0) {
                    // ç—›è‹¦è¡¨æƒ…
                    ctx.arc(headX + eyeOffset, headY + 8, 5, 0, Math.PI);
                } else {
                    // æ­£å¸¸è¡¨æƒ…
                    ctx.moveTo(headX + eyeOffset - 3, headY + 8);
                    ctx.lineTo(headX + eyeOffset + 3, headY + 8);
                }
                ctx.stroke();

                // æ‰‹è‡‚
                ctx.fillStyle = baseColor;
                ctx.strokeStyle = this.borderColor;
                ctx.lineWidth = 3;

                // å‰è‡‚
                const armX = this.facing === 1 ? this.x + 45 : this.x - 25;
                ctx.fillRect(armX, this.y + 35, 20, 35);
                ctx.strokeRect(armX, this.y + 35, 20, 35);

                // æ‰‹
                ctx.fillStyle = '#ffd5b5';
                ctx.beginPath();
                ctx.arc(armX + 10, this.y + 55, 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#e8c4a4';
                ctx.lineWidth = 1;
                ctx.stroke();

                // è„šéƒ¨
                ctx.fillStyle = '#1a1a2e';
                const footWidth = 25;
                const footHeight = 15;
                ctx.fillRect(this.x + 12, this.y + 100, footWidth, footHeight);
                ctx.fillRect(this.x + 35, this.y + 100, footWidth, footHeight);

                // é‹å­è¾¹æ¡†
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.strokeRect(this.x + 12, this.y + 100, footWidth, footHeight);
                ctx.strokeRect(this.x + 35, this.y + 100, footWidth, footHeight);

                // æ”»å‡»æ•ˆæœ
                if (this.isAttacking) {
                    ctx.fillStyle = 'rgba(255, 255, 0, 0.7)';
                    const attackX = this.x + (this.facing === 1 ? this.width : -60);
                    ctx.beginPath();
                    ctx.arc(attackX + 30, this.y + this.height / 2, 25, 0, Math.PI * 2);
                    ctx.fill();
                }

                // å¿…æ€æŠ€æ•ˆæœ
                if (this.isSpecial) {
                    ctx.fillStyle = 'rgba(255, 0, 255, 0.8)';
                    const attackX = this.x + (this.facing === 1 ? this.width : -150);
                    ctx.beginPath();
                    ctx.arc(attackX + 75, this.y + this.height / 2, 60, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // èƒ½é‡æ³¢
                    ctx.strokeStyle = '#ff00ff';
                    ctx.lineWidth = 5;
                    ctx.beginPath();
                    ctx.arc(attackX + 75, this.y + this.height / 2, 80, 0, Math.PI * 2);
                    ctx.stroke();
                }

                // é˜²å¾¡æ•ˆæœ
                if (this.isBlocking) {
                    ctx.fillStyle = 'rgba(0, 255, 255, 0.3)';
                    ctx.fillRect(this.x - 10, this.y - 10, this.width + 20, this.height + 20);
                }
            }
        }

        // ==================== æ¸¸æˆåˆå§‹åŒ– ====================
        function init() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');

            // ç¡®ä¿ canvas ä½¿ç”¨å›ºå®šå°ºå¯¸ï¼ˆä¸è¿›è¡Œç¼©æ”¾ï¼‰
            // ç§»åŠ¨ç«¯é€‚é…é€šè¿‡ CSS å®ç°ï¼Œè€Œä¸æ˜¯ç¼©æ”¾ canvas å†…å®¹
            canvas.width = CONFIG.canvasWidth;
            canvas.height = CONFIG.canvasHeight;

            // ç§»åŠ¨ç«¯ï¼šé€šè¿‡ CSS ç¼©æ”¾æ•´ä¸ª canvasï¼Œè€Œä¸æ˜¯ç¼©æ”¾å†…å®¹
            if (window.innerWidth <= 768) {
                const scale = Math.min(
                    (window.innerWidth - 40) / CONFIG.canvasWidth,
                    (window.innerHeight - 300) / CONFIG.canvasHeight
                );
                canvas.style.width = (CONFIG.canvasWidth * scale) + 'px';
                canvas.style.height = (CONFIG.canvasHeight * scale) + 'px';
            } else {
                canvas.style.width = CONFIG.canvasWidth + 'px';
                canvas.style.height = CONFIG.canvasHeight + 'px';
            }

            resetPlayers();
            setupEventListeners();
            showControlsHelp();
        }

        function resetPlayers() {
            player1 = new Fighter(FIGHTERS.p1, 100, 1);
            player2 = new Fighter(FIGHTERS.p2, CONFIG.canvasWidth - 160, -1);
        }

        function setupEventListeners() {
            window.addEventListener('keydown', (e) => {
                keys[e.key.toLowerCase()] = true;
                keys[e.code] = true;
            });

            window.addEventListener('keyup', (e) => {
                keys[e.key.toLowerCase()] = false;
                keys[e.code] = false;
            });

            setupMobileControls();
        }

        // ==================== ç§»åŠ¨ç«¯æ§åˆ¶ ====================
        function setupMobileControls() {
            const joystick = document.getElementById('joystick');
            const joystickKnob = document.getElementById('joystickKnob');
            const actionButtons = document.querySelectorAll('.action-btn');

            // è™šæ‹Ÿæ‘‡æ†æ§åˆ¶
            let joystickActive = false;
            const joystickCenter = { x: 60, y: 60 };

            joystick.addEventListener('touchstart', (e) => {
                joystickActive = true;
                handleJoystickTouch(e.touches[0]);
            });

            joystick.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (joystickActive) {
                    handleJoystickTouch(e.touches[0]);
                }
            });

            joystick.addEventListener('touchend', (e) => {
                joystickActive = false;
                resetJoystick();
            });

            function handleJoystickTouch(touch) {
                const rect = joystick.getBoundingClientRect();
                const touchX = touch.clientX - rect.left - joystickCenter.x;
                const touchY = touch.clientY - rect.top - joystickCenter.y;

                const maxMove = 35;
                const distance = Math.min(Math.sqrt(touchX * touchX + touchY * touchY), maxMove);
                const angle = Math.atan2(touchY, touchX);

                const knobX = Math.cos(angle) * distance;
                const knobY = Math.sin(angle) * distance;

                joystickKnob.style.transform = `translate(calc(-50% + ${knobX}px), calc(-50% + ${knobY}px))`;

                // æ˜ å°„åˆ°æ¸¸æˆæŒ‰é”®
                if (distance > 10) {
                    if (Math.abs(knobX) > Math.abs(knobY)) {
                        keys['a'] = knobX < 0;
                        keys['d'] = knobX > 0;
                        keys['w'] = false;
                    } else {
                        keys['w'] = knobY < 0;
                        keys['a'] = false;
                        keys['d'] = false;
                    }
                }
            }

            function resetJoystick() {
                joystickKnob.style.transform = 'translate(-50%, -50%)';
                keys['w'] = keys['a'] = keys['d'] = false;
            }

            // åŠ¨ä½œæŒ‰é’®æ§åˆ¶
            actionButtons.forEach(btn => {
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const action = btn.dataset.action;
                    handleAction(action, true);
                });

                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    const action = btn.dataset.action;
                    handleAction(action, false);
                });
            });
        }

        function handleAction(action, active) {
            switch(action) {
                case 'jump':
                    keys['w'] = active;
                    break;
                case 'attack':
                    keys['j'] = active;
                    break;
                case 'attack2':
                    keys['k'] = active;
                    break;
                case 'special':
                    keys['l'] = active;
                    break;
            }
        }

        function showControlsHelp() {
            const helpKeys = `
            P1 æ§åˆ¶:
            - W: è·³è·ƒ
            - A: å·¦ç§»
            - D: å³ç§»
            - S: è¹²ä¸‹
            - J: æ‹³æ”»å‡»
            - K: è„šæ”»å‡»
            - L: å¿…æ€æŠ€
            
            P2 æ§åˆ¶:
            - â†‘: è·³è·ƒ
            - â†: å·¦ç§»
            - â†’: å³ç§»
            - â†“: è¹²ä¸‹
            - 1: æ‹³æ”»å‡»
            - 2: è„šæ”»å‡»
            - 3: å¿…æ€æŠ€
            
            æç¤º:
            - ç§»åŠ¨ä¸­æŒ‰ç›¸åæ–¹å‘å¯ä»¥é˜²å¾¡
            - å¿…æ€æŠ€éœ€è¦èƒ½é‡æ»¡ä¸€åŠ
            - è¿ç»­æ”»å‡»è§¦å‘è¿å‡»`;
            
            alert(helpKeys);
        }

        // ==================== æ¸¸æˆå¾ªç¯ ====================
        function gameLoop() {
            if (gameState !== 'playing') return;

            update();
            draw();
            animationFrame = requestAnimationFrame(gameLoop);
        }

        function update() {
            // P1 æŒ‰é”®æ˜ å°„
            const p1Keys = {
                left: keys['a'],
                right: keys['d'],
                jump: keys['w'],
                attack: keys['j'],
                special: keys['l']
            };

            // P2 æŒ‰é”®æ˜ å°„
            const p2Keys = {
                left: keys['arrowleft'],
                right: keys['arrowright'],
                jump: keys['arrowup'],
                attack: keys['digit1'],
                special: keys['digit3']
            };

            // AI å¯¹æˆ˜æ¨¡å¼
            if (gameMode === 'ai') {
                updateAI(player2, player1);
                p2Keys = getAIKeys();
            }

            // æ›´æ–°è§’è‰²
            player1.update(p1Keys, player2);
            player2.update(p2Keys, player1);

            // å¤„ç†æ”»å‡»
            if (p1Keys.attack) player1.attack(player2);
            if (p2Keys.attack) player2.attack(player1);
            if (p1Keys.special) player1.specialAttack(player2);
            if (p2Keys.special) player2.specialAttack(player1);

            // æ›´æ–°UI
            updateHUD();

            // æ£€æŸ¥æ¸¸æˆç»“æŸ
            checkGameOver();
        }

        function draw() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶èƒŒæ™¯ï¼ˆåœ°é¢ï¼‰
            const gradient = ctx.createLinearGradient(0, CONFIG.groundY - 100, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(0.7, '#98FB98');
            gradient.addColorStop(1, '#8B4513');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶åœ°é¢
            ctx.fillStyle = '#654321';
            ctx.fillRect(0, CONFIG.groundY, canvas.width, canvas.height - CONFIG.groundY);
            ctx.fillStyle = '#7EC850';
            ctx.fillRect(0, CONFIG.groundY, canvas.width, 10);

            // ç»˜åˆ¶è§’è‰²
            player1.draw(ctx);
            player2.draw(ctx);
        }

        function updateHUD() {
            document.getElementById('healthP1').style.width = player1.health + '%';
            document.getElementById('healthP2').style.width = player2.health + '%';
            document.getElementById('energyP1').style.width = player1.energy + '%';
            document.getElementById('energyP2').style.width = player2.energy + '%';
            document.getElementById('timer').textContent = timer;
        }

        function showCombo(combo) {
            if (typeof combo === 'string') {
                showComboText('SPECIAL!');
            } else {
                showComboText(combo + ' HITS!');
            }
        }

        function showComboText(text) {
            const existing = document.querySelector('.combo-display');
            if (existing) existing.remove();

            const comboEl = document.createElement('div');
            comboEl.className = 'combo-display';
            comboEl.textContent = text;
            document.body.appendChild(comboEl);

            setTimeout(() => {
                comboEl.remove();
            }, 1000);
        }

        function checkGameOver() {
            if (player1.health <= 0 || player2.health <= 0) {
                if (player1.health <= 0) {
                    roundWins.p2++;
                } else {
                    roundWins.p1++;
                }

                if (roundWins.p1 >= 2 || roundWins.p2 >= 2) {
                    endGame();
                } else {
                    nextRound();
                }
            } else if (timer <= 0) {
                // æ—¶é—´åˆ°ï¼Œè¡€é‡å¤šçš„è·èƒœ
                if (player1.health > player2.health) {
                    roundWins.p1++;
                } else if (player2.health > player1.health) {
                    roundWins.p2++;
                } else {
                    // å¹³å±€ï¼Œéšæœº
                    if (Math.random() > 0.5) {
                        roundWins.p1++;
                    } else {
                        roundWins.p2++;
                    }
                }

                if (roundWins.p1 >= 2 || roundWins.p2 >= 2) {
                    endGame();
                } else {
                    nextRound();
                }
            }
        }

        function nextRound() {
            clearInterval(timerInterval);
            cancelAnimationFrame(animationFrame);
            
            // é‡ç½®çŠ¶æ€
            resetPlayers();
            timer = CONFIG.roundTime;
            gameState = 'paused';

            const winner = roundWins.p1 > roundWins.p2 ? 'Player 1' : 'Player 2';
            setTimeout(() => {
                alert(`ç¬¬ ${roundWins.p1 + roundWins.p2} å›åˆç»“æŸ!\nå½“å‰æ¯”åˆ†: ${roundWins.p1} - ${roundWins.p2}`);
                startRound();
            }, 500);
        }

        function endGame() {
            clearInterval(timerInterval);
            cancelAnimationFrame(animationFrame);
            gameState = 'gameover';

            const winner = roundWins.p1 >= 2 ? 'Player 1' : 'Player 2';
            document.getElementById('winnerText').textContent = winner + ' è·èƒœ!';
            document.getElementById('scoreText').textContent = `æœ€ç»ˆæ¯”åˆ†: ${roundWins.p1} - ${roundWins.p2}`;
            document.getElementById('gameOver').style.display = 'flex';
        }

        // ==================== æ¸¸æˆæ§åˆ¶ ====================
        function startGame(mode) {
            gameMode = mode || 'pvp';
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('visible');

            roundWins = { p1: 0, p2: 0 };
            startRound();
        }

        function startRound() {
            gameState = 'playing';
            resetPlayers();
            timer = CONFIG.roundTime;
            
            // å¼€å§‹è®¡æ—¶å™¨
            timerInterval = setInterval(() => {
                timer--;
                if (timer <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);

            // å¼€å§‹æ¸¸æˆå¾ªç¯
            gameLoop();
        }

        function restartGame() {
            document.getElementById('gameOver').style.display = 'none';
            startGame();
        }

        function goToMenu() {
            clearInterval(timerInterval);
            cancelAnimationFrame(animationFrame);
            gameState = 'menu';

            // è·³è½¬åˆ°ä¸»é¡µ
            window.location.href = '../../index.html';
        }

        function showControls() {
            showControlsHelp();
        }

        // ==================== AI å¯¹æˆ˜ç³»ç»Ÿ ====================
        function updateAI(aiPlayer, humanPlayer) {
            aiActionTimer--;

            const distance = Math.abs(aiPlayer.x - humanPlayer.x);
            const isFacingHuman = (aiPlayer.facing === 1 && humanPlayer.x > aiPlayer.x) ||
                                 (aiPlayer.facing === -1 && humanPlayer.x < aiPlayer.x);

            // AI å†³ç­–é€»è¾‘
            if (aiActionTimer <= 0) {
                // é‡ç½®AIæ“ä½œ
                aiKeys = { left: false, right: false, jump: false, attack: false, special: false };

                // æ ¹æ®è·ç¦»å†³å®šè¡ŒåŠ¨
                if (distance > 150) {
                    // é è¿‘å¯¹æ‰‹
                    aiCurrentAction = 'approach';
                    aiKeys.right = humanPlayer.x > aiPlayer.x;
                    aiKeys.left = humanPlayer.x < aiPlayer.x;
                    aiActionTimer = 20;
                } else if (distance < 60 && isFacingHuman) {
                    // æ”»å‡»èŒƒå›´
                    const randomAction = Math.random();
                    if (aiPlayer.energy >= 50 && randomAction < 0.2) {
                        aiCurrentAction = 'special';
                        aiKeys.special = true;
                        aiActionTimer = 10;
                    } else if (randomAction < 0.7) {
                        aiCurrentAction = 'attack';
                        aiKeys.attack = true;
                        aiActionTimer = 15;
                    } else {
                        aiCurrentAction = 'retreat';
                        aiKeys.left = humanPlayer.x > aiPlayer.x;
                        aiKeys.right = humanPlayer.x < aiPlayer.x;
                        aiActionTimer = 15;
                    }
                } else {
                    // ä¸­ç­‰è·ç¦»ï¼Œé€‰æ‹©é è¿‘æˆ–è·³è·ƒ
                    const randomAction = Math.random();
                    if (randomAction < 0.6) {
                        aiCurrentAction = 'approach';
                        aiKeys.right = humanPlayer.x > aiPlayer.x;
                        aiKeys.left = humanPlayer.x < aiPlayer.x;
                        aiActionTimer = 15;
                    } else {
                        aiCurrentAction = 'jump';
                        aiKeys.jump = true;
                        aiActionTimer = 10;
                    }
                }

                // é˜²å¾¡å†³ç­–
                if (humanPlayer.isAttacking && distance < 100 && Math.random() < 0.5) {
                    aiKeys.right = humanPlayer.x > aiPlayer.x;
                    aiKeys.left = humanPlayer.x < aiPlayer.x;
                }
            }
        }

        function getAIKeys() {
            return aiKeys;
        }

        // ==================== å¯åŠ¨æ¸¸æˆ ====================
        window.onload = init;
    </script>
</body>
</html>
